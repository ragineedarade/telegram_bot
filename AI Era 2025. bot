import logging
from telegram import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo, Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)
import asyncio

# Logging setup
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# Main menu keyboard with emojis and better grouping
main_keyboard = ReplyKeyboardMarkup(
    [
        ["ğŸ¤– ChatGPT", "ğŸŒŸ Gemini AI"],
        ["ğŸ” DeepSeek", "ğŸ’¡ Grok"],
        ["ğŸ¤ AI Agents"],
        ["ğŸ“ Contact", "â“ Help"]
    ],
    resize_keyboard=True
)

# Help submenu keyboard with emojis
help_keyboard = ReplyKeyboardMarkup(
    [
        ["ğŸ’¬ General Inquiry", "âš ï¸ Issue With Tool"],
        ["âœ… Submit"]
    ],
    resize_keyboard=True
)

# /start command handler


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await update.message.reply_text(
        f"ğŸ‘‹ Hello {user.first_name}, welcome to *AI Era 2025!* ğŸš€\n\n"
        "Access powerful AI tools from one place and boost your productivity! ğŸ’»âœ¨",
        reply_markup=main_keyboard,
        parse_mode="Markdown"
    )

# Message handler


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    if text == "ğŸ“ Contact":
        await update.message.reply_text("ğŸ“§ Email us at: support@aiera2025.com")

    elif text == "â“ Help":
        await update.message.reply_text(
            "ğŸ” Select your issue or inquiry below:",
            reply_markup=help_keyboard
        )

    elif text == "ğŸ’¬ General Inquiry":
        await update.message.reply_text("ğŸ“ Please share your query. Weâ€™re here to help! ğŸ˜Š")

    elif text == "âš ï¸ Issue With Tool":
        await update.message.reply_text("âš™ï¸ Please mention the tool and issue briefly.")

    elif text == "âœ… Submit":
        await update.message.reply_text("ğŸ™ Thank you! Weâ€™ll review and respond shortly.")

    elif text == "ğŸ¤ AI Agents":
        ai_keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("âœï¸ Writing Assistant", web_app=WebAppInfo(
                url="https://yourdomain.com/writing"))],
            [InlineKeyboardButton("ğŸ–¼ï¸ Image Generator", web_app=WebAppInfo(
                url="https://yourdomain.com/image"))],
            [InlineKeyboardButton("ğŸ“Š Grammer Analyzer", web_app=WebAppInfo(
                url="https://www.grammarly.com/?utm_source=chatgpt.com"))],
            [InlineKeyboardButton("ğŸ’» Code Explainer", web_app=WebAppInfo(
                url="https://yourdomain.com/code"))],
            [InlineKeyboardButton("ğŸ“š Book Summary", web_app=WebAppInfo(
                url="https://yourdomain.com/summary"))]
        ])
        await update.message.reply_text(
            "ğŸ¤– Select an AI Agent to launch:",
            reply_markup=ai_keyboard
        )

    elif text == "ğŸ¤– ChatGPT" or text == "ChatGPT":
        await update.message.reply_text(
            "ğŸš€ Launching ChatGPT...",
            reply_markup=InlineKeyboardMarkup(
                [[InlineKeyboardButton("Open ChatGPT", web_app=WebAppInfo(
                    url="https://yourdomain.com/chatgpt"))]]
            )
        )

    elif text == "ğŸŒŸ Gemini AI" or text == "Gemini AI":
        await update.message.reply_text(
            "ğŸš€ Launching Gemini AI...",
            reply_markup=InlineKeyboardMarkup(
                [[InlineKeyboardButton("Open Gemini AI", web_app=WebAppInfo(
                    url="https://yourdomain.com/gemini"))]]
            )
        )

    elif text == "ğŸ” DeepSeek" or text == "DeepSeek":
        await update.message.reply_text(
            "ğŸš€ Launching DeepSeek...",
            reply_markup=InlineKeyboardMarkup(
                [[InlineKeyboardButton("Open DeepSeek", web_app=WebAppInfo(
                    url="https://yourdomain.com/deepseek"))]]
            )
        )

    elif text == "ğŸ’¡ Grok" or text == "Grok":
        await update.message.reply_text(
            "ğŸš€ Launching Grok...",
            reply_markup=InlineKeyboardMarkup(
                [[InlineKeyboardButton("Open Grok", web_app=WebAppInfo(
                    url="https://yourdomain.com/grok"))]]
            )
        )

    else:
        await update.message.reply_text(
            "â“ I didnâ€™t understand that. Please use the options below.",
            reply_markup=main_keyboard
        )

# Coroutine to delete webhook before polling


async def delete_webhook(token: str):
    app = ApplicationBuilder().token(token).build()
    await app.bot.delete_webhook()


def main():
    TOKEN = "7596648132:AAEej8lW2TBpqEqmj0KA8M7t3eXCD-hjt6I"

    # Delete webhook first (run this synchronously here)

    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(
        filters.TEXT & ~filters.COMMAND, handle_message))

    print("ğŸ¤– AI Era 2025 Bot is running...")

    # Create and set a new event loop explicitly (fix for Python 3.12+)
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

    # Now run polling (this blocks and runs in the new event loop)
    app.run_polling()


if __name__ == "__main__":
    main()
